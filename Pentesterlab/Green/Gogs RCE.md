## Introduction
-->This exercise covers how to get code execution against the Git self hosted tool: Gogs.(CVE 2018-18925)
-->This course details the exploitation of a remote commands execution (RCE) vulnerability in [Gogs](https://gogs.io/), a tool to host your own git repositories. This exploit works in the default install (if registration is enabled) and is based on multiple steps to get code execution.
-->The attack is divided into 2 steps:
1.  Bypass the authentication to become the user `administrator`.
2.  Use a hook to get commands execution.
-->For Chinese speakers, you can find the initial coverage of this bug [here](https://www.anquanke.com/post/id/163575). But be aware that they are linking to the wrong version of the `EncodeGob` function: `cache/utils.go` vs `session/utils.go`.
-->This bug also impacts [Gitea](https://gitea.io/).

## Authentication Bypass
-->Gogs is based on the [Macaron](https://go-macaron.com/) framework. The system used to manage session is very similar to what PHP does. The session identifier in the cookie is mapped to a file on the file system. When the web server receives a request with a session identifier (as a cookie), it looks up for the file on the file system using the following: `BASE_PATH+[SESSION_ID]`. If the file exists and can be parsed, the information in the local file provides details about the user (for example the `user_id`).

## The vulnerability
-->The vulnerability is a simple directory traversal when retrieving the file used for the session on the file system. You can for example, set the `i_like_gogits` cookie to `../../../../../../etc/passwd` to get an error from the server.

# Exploitation
## Generating the malicious session file
-->In order to exploit the session bypass, we will need a way to upload a specially crafted file, then we will use this file as our session id.
-->There are two ways to create a malicious session file:
-   run your own instance and logging as administrator, then retrieve the file on your server by looking in `/data/gogs/data/sessions/`.
-   build your own tool to generate the malicious file.
-->To build your own tool, you need to look at the code used by Gogs and more specifically the following files:
-   [/vendor/github.com/go-macaron/session/utils.go](https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/vendor/github.com/go-macaron/session/utils.go#L38-L45): for the encoding of the session.
-   [/models/user.go](https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/user.go#L50-L52): for the types of the `user ID` and `uname`.
-   [routes/user/auth.go](https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/routes/user/auth.go#L127-L128): for the values to put in the session
-->By putting together, all the code you need, you should be able to get something similar to the following Go code:
```go
	package main
	 
	import (
	  "bytes"
	  "encoding/gob"
	  "io/ioutil"
	  "fmt"
	)  
	 
	func EncodeGob(obj map[interface{}]interface{}) ([]byte, error) {
	  for _, v := range obj {
	    gob.Register(v)
	  }
	  buf := bytes.NewBuffer(nil)
	  err := gob.NewEncoder(buf).Encode(obj)
	  return buf.Bytes(), err
	}
	 
	 
	func main() {
	  var data []byte
	  var kv = make(map[interface{}]interface{})
	  kv["uname"]= "administrator"
	  kv["uid"]= int64(1)
	  fmt.Println(kv) 
	 
	  data, err := EncodeGob(kv);
	  if err !=nil { 
	    fmt.Println(err)
	  }
	  ioutil.WriteFile("payload", data, 0644)
	 
	}
```
-->By running this code, you should end up with a file that you can use as a session file.

## Uploading the malicious file
-->Gogs offers three ways to put files on the server:
-   Using the upload functionality in the issue tracker.
-   Using git by doing a git push.
-   Using "Upload file" in a given repository (with a least one commit).
-->By default, the upload functionality limits the type of file you're uploading and does some level of content sniffing (using [Golang http.DetectContentType](https://golang.org/pkg/net/http/#DetectContentType)). Pushing with git will create a git commit that will contain the file but it may cause problems as there is going to be extra content in this file. Your best bet is to use the "Upload file" functionality, as it will force Gogs to create a local copy of the repository (so you will get the files on the server without any extra content in them).

## Getting logged in as administrator
-->When creating the copy of the repository locally, Gogs put the files in `/data/gogs/data/tmp/local-repo/[REPO_ID]/[FILENAME]` (this repository is only created when you use the "Upload file" functionality). Where `[FILENAME]` is the name of the file you upload and `[REPO_ID]` is the repository identifier that can be found using the `Fork` link:![](https://assets.pentesterlab.com/cve-2018-18925/fork.png)

-->You can find this information by running your own instance of Gogs or look at the [source code](https://github.com/gogs/gogs/blob/be6bb5314ee7d8ed53362d8e6893b061e5210f48/models/repo.go#L594-L596).
-->By default, the sessions are stored in `/data/gogs/data/sessions/` (for example `/data/gogs/data/sessions/6/0/60d5eae5ed699803` when the session id is `60d5eae5ed699803`). Therefore, you can use the following relative path for your session id: `../tmp/local-repo/[REPO_ID]/[FILENAME]`. By using this path in your `i_like_gogits` cookie, you should be logged in as `administrator`.

## Gaining commands execution
-->Once you are logged in as `administrator`, you can use the `git hooks` (you can read more about `git hooks` [here](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks) ) functionality in a given repository to run a shell script. You can put the `score` command inside the git hook script. Then you will just need to `git push` a commit to that repository to get the hook executed.

## Conclusion
-->This exercise showed you how you can chain vulnerabilities to gain more and more access in an application and finally gain code execution. The most important things to remember from this exercise is how you can combine a file upload and a directory traversal in the session management to bypass the authentication. I hope you enjoyed learning with PentesterLab.