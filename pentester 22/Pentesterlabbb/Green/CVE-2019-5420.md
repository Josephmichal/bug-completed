## Introduction
-->This exercise details the exploitation of CVE-2019-5420 to forge a session as another user
-->This course details the exploitation of a vulnerability in Ruby-on-Rails when it is running in development mode. In development mode, it is possible for an attacker to guess the key used to secure the sessions.

## The bug
-->The issue is fairly simple, to secure the sessions in development mode, the application derives the key from the name of the application. Therefore, if you know the name of the application, you can retrieve the encryption key. Having the encryption key allows you to decrypt your session, tamper with it and re-encrypt it.
-->If we look at the patch, we can see that the issue is pretty obvious:
```
	      def secret_key_base
	-      if Rails.env.test? || Rails.env.development?
	-        secrets.secret_key_base || Digest::MD5.hexdigest(self.class.name)
	+      if Rails.env.development? || Rails.env.test?
	+        secrets.secret_key_base ||= generate_development_secret
```

## Writing your own tool
-->To write your tool, you will need to deep dive into Rails' internals. To make things easier, you should look at the following files:
-   [`activesupport/lib/active_support/message_encryptor.rb`](https://github.com/rails/rails/blob/v5.2.2/activesupport/lib/active_support/message_encryptor.rb) and more specifically the following methods: [`\_encrypt`](https://github.com/rails/rails/blob/v5.2.2/activesupport/lib/active_support/message_encryptor.rb#L166) and [`\_decrypt`](https://github.com/rails/rails/blob/v5.2.2/activesupport/lib/active_support/message_encryptor.rb#L166)
-   [activesupport/lib/active_support/key_generator.rb](https://github.com/rails/rails/blob/v5.2.2/activesupport/lib/active_support/key_generator.rb) and more specifically the following method: [`generate_key`](https://github.com/rails/rails/blob/v5.2.2/activesupport/lib/active_support/key_generator.rb#L22).
-   [`railties/lib/rails/application.rb`](https://github.com/rails/rails/blob/v5.2.2/railties/lib/rails/application.rb) and more specifically the following method: [`key_generator`](https://github.com/rails/rails/blob/v5.2.2/railties/lib/rails/application.rb#L172).
-   [`actionpack/lib/action\_dispatch/railtie.rb`](https://github.com/rails/rails/blob/v5.2.2/actionpack/lib/action_dispatch/railtie.rb) and more specifically the following value [`config.action\_dispatch.encrypted\_signed\_cookie\_salt`](https://github.com/rails/rails/blob/v5.2.2/actionpack/lib/action_dispatch/railtie.rb#L21).
-->As always, the tests provide a lot of details to piece things together: [`actionpack/test/dispatch/session/cookie\_store\_test.rb`](https://github.com/rails/rails/blob/v5.2.2/actionpack/test/dispatch/session/cookie_store_test.rb).
-->Finally, you need to know that Rails will add `::Application` to the name of the application before performing the md5: `PentesterLab` becomes `PentesterLab::Application`
-->With this information, you should be able to decrypt the session and re-encrypt it after changing your `user_id`.
-->If you come across this issue in the wild, it is always worth looking at the name of the cookie used as it is also based on the name of the application. Furthermore, if the session contains something similar to:
```perl
"warden.user.user.key":[[1],"$2a$11$BkGB3JhRmoQ3jKbSxx.byO"]
```
-->The application uses [devise](https://github.com/plataformatec/devise) and you won't be able to forge a valid session without knowing the password of the user (`$2a$11$BkGB3JhRmoQ3jKbSxx.byO` are the first 29 bytes of the `bcrypt` of the password).

## Conclusion
-->This exercise showed you how to exploit the vulnerability CVE-2019-5420 to forge a session. I hope the course provided you with more details on how this vulnerability works and how you can get a working exploit.